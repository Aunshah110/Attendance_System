{% extends "base.html" %}
{% block content %}

<style>
  :root{
    --black: #070707;
    --brown-dark: #3e2a1f;
    --brown-mid: #7a5230;
    --brown-light: #d2a679;
    --cream: #f5f5dc;
    --yellow: #FFD24A;
    --transition: all 0.28s cubic-bezier(.2,.9,.3,1);
  }

  body{
    background: linear-gradient(135deg, var(--brown-light) 0%, var(--cream) 100%);
    min-height:100vh;
    margin:0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: var(--cream);
  }

  /* STATIC DOT BACKGROUND (NO ANIMATION) */
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background: radial-gradient(circle, rgba(255,255,255,0.08) 10%, transparent 10.5%);
    background-size: 30px 30px;
    z-index:-1;
  }

  .navbar {
    position: fixed !important;
    top: 0; left: 0; right: 0;
    z-index: 9999;
    background: rgba(112, 62, 35, 0.9);
    border-bottom: 2px solid var(--yellow);
  }

  .admin-wrapper {
    padding: calc(140px + 1.5rem) 1rem 4rem;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  .dashboard-card{
    width: min(900px, 100%);
    background: rgba(112, 62, 35, 0.9);
    border-bottom: 2px solid var(--yellow);
    border-radius: 16px;
    padding: 28px;
    box-shadow: 0 20px 40px rgba(15,10,8,0.35);
    backdrop-filter: blur(8px);
  }

  /* FORM LAYOUT */
  form{
    width:100%;
    max-width: 720px;
    margin-inline:auto;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.2rem 1.5rem;
  }

  .form-label {
    font-weight:600;
    margin-bottom: 4px;
    display:block;
  }

  .form-control,
  .form-select {
    border-radius: 8px;
    padding: 9px 12px;
    border: 2px solid var(--brown-mid);
    background: var(--cream);
    color: var(--black);
    transition: var(--transition);
    width:100%;
    font-size: 0.95rem;
  }

  .form-control:focus,
  .form-select:focus {
    outline:none;
    border-color: var(--yellow);
    box-shadow: 0 0 0 3px rgba(255,210,74,0.25);
  }

  /* FULL WIDTH SECTIONS */
  .full-span {
    grid-column: 1 / -1;
  }

  hr{
    margin: 3rem 0 2rem;
    border-color: rgba(255,255,255,0.2);
  }

  @media (max-width: 576px){
    .dashboard-card{ padding: 20px; }
  }
</style>
<link rel="stylesheet" href="styles.css">

<div class="admin-wrapper">
  <div class="dashboard-card">

    <h1>Register Users</h1>

    <form method="POST" id="userForm">

      <div>
        <label class="form-label">User ID</label>
        <input type="text" class="form-control" name="user_id" required>
      </div>

      <div>
        <label class="form-label">Name</label>
        <input type="text" class="form-control" name="name" required>
      </div>

      <div>
        <label class="form-label">Email</label>
        <input type="email" class="form-control" name="email" id="email" required>
      </div>

      <div>
        <label class="form-label">Password</label>
        <input type="password" class="form-control" name="password" id="password" required>
      </div>

      <div class="full-span">
        <label class="form-label">Role</label>
        <select class="form-select" id="role" name="role" required>
          <option value="">-- Select Role --</option>
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>
      </div>

      <div id="studentFields" class="full-span" style="display:none">
        <div style="display:grid; gap:1.2rem; grid-template-columns: repeat(auto-fit,minmax(240px,1fr));">

          <div>
            <label class="form-label">Batch</label>
            <select id="batchSelect" name="batch_id" class="form-control" required>
              <option value="">-- Select Batch --</option>
              {% for batch in batches %}
              <option value="{{ batch[0] }}">{{ batch[1] }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="form-label">Department</label>
            <select id="departmentSelect" name="department_id" class="form-control" required>
              <option value="">-- Select Department --</option>
              {% for department in departments %}
              <option value="{{ department[0] }}">{{ department[1] }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="form-label">Section</label>
            <input type="text" id="sectionDisplay" class="form-control" value="None" readonly style="display:block;">

            <select id="sectionSelect" name="section_id" class="form-control" style="display:none;">
              <option value="">-- Select Section --</option>
            </select>
          </div>

          <div>
            <label class="form-label">Batch Status</label>
            <select class="form-select" id="batch_status" name="batch_status" required>
              <option value="">--Select Batch Status--</option>
              <option value="old">Old</option>
              <option value="new">New</option>
            </select>
          </div>

          <div id="admissionDateField" style="display:none">
            <label class="form-label">Date of Admission</label>
            <input type="date" class="form-control" name="admission_date">
          </div>

        </div>
      </div>
      <div class="mt-4 d-flex justify-content-center gap-3 flex-wrap">
          <button type="submit" class="btn-dashboard"><span>Register User</span></button>
          <a href="{{ url_for('home') }}" class="btn-dashboard"><span>Back</span></a>
      </div>
    </form>

    <hr>

    <h1>Import Users Records</h1>

    <form method="POST" enctype="multipart/form-data" action="{{ url_for('import_users') }}"
            id="importForm">
      <div class="full-span">
        <label class="form-label">Upload CSV File</label>
        <input type="file" class="form-control" name="csv_file" accept=".csv" required>
      </div>
      <div class="mt-4 d-flex justify-content-center gap-3 flex-wrap">
        <button type="submit" class="btn-dashboard"><span>Import Records</span></button>
      </div>
    </form>

  </div>
</div>

<div id="pageLoader" style="display:none;">
  <div class="loader-spinner"></div>
</div>


<script>
const roleSelect = document.getElementById('role');
const studentFields = document.getElementById('studentFields');
const batchStatus = document.getElementById('batch_status');
const admissionDateField = document.getElementById('admissionDateField');

const batchSelect = document.getElementById('batchSelect');
const deptSelect = document.getElementById('departmentSelect');
const sectionDisplay = document.getElementById('sectionDisplay');
const sectionSelect = document.getElementById('sectionSelect');

/* ---------------- ROLE TOGGLE ---------------- */

roleSelect.addEventListener('change', e => {
  const isStudent = e.target.value === 'student';

  studentFields.style.display = isStudent ? 'block' : 'none';

  // toggle required attributes safely
  batchSelect.required = isStudent;
  deptSelect.required = isStudent;
  batchStatus.required = isStudent;

  if (!isStudent) {
    // clear student-only values so NULL goes to backend
    batchSelect.value = '';
    deptSelect.value = '';
    sectionSelect.value = '';
    batchStatus.value = '';
    admissionDateField.style.display = 'none';
  }
});


/* ---------------- BATCH STATUS ---------------- */

batchStatus.addEventListener('change', e => {
  const isNew = e.target.value === 'new';
  admissionDateField.style.display = isNew ? 'block' : 'none';

  const adInput = admissionDateField.querySelector('input');
  adInput.required = isNew;
});


/* ---------------- AUTO SECTION CHECK ---------------- */

function checkSection() {
  const batch = batchSelect.value;
  const dept = deptSelect.value;

  // Reset both
  sectionDisplay.style.display = 'block';
  sectionSelect.style.display = 'none';
  sectionDisplay.value = 'None';
  sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';

  if (!batch || !dept) return;

  fetch(`/admin/check_sections?batch_id=${batch}&department_id=${dept}`)
    .then(res => res.json())
    .then(data => {

      if (data.length === 0) {
        // No section
        sectionDisplay.value = 'None';
      }
      else if (data.length === 1) {
        // Single section → read-only
        sectionDisplay.value = `${data[0][1]}`;
        sectionSelect.value = data[0][0]; // hidden value for submission
      }
      else {
        // Multiple sections → show dropdown
        sectionDisplay.style.display = 'none';
        sectionSelect.style.display = 'block';
        data.forEach(s => {
          const option = document.createElement('option');
          option.value = s[0];
          option.text = `${s[1]}`;
          sectionSelect.add(option);
        });
      }

    })
    .catch(err => {
      console.error(err);
      sectionDisplay.value = 'Error';
    });
}

batchSelect.addEventListener('change', checkSection);
deptSelect.addEventListener('change', checkSection);

/* ---------------- FORM VALIDATION ---------------- */
document.getElementById('userForm').addEventListener('submit', function(e) {

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  if (!email.endsWith('@gmail.com')) {
    alert('Email must be a valid @gmail.com address.');
    e.preventDefault(); return;
  }

  if (password.length < 8) {
    alert('Password must be at least 8 characters long.');
    e.preventDefault(); return;
  }

  // Section validation
  if (sectionSelect.style.display === 'block' && !sectionSelect.value) {
    alert('Please select a section for this Batch and Department.');
    e.preventDefault(); return;
  }

});

document.getElementById('importForm').addEventListener('submit', function(){

  const loader = document.getElementById('pageLoader');
  loader.style.display = 'flex';

});
</script>


{% endblock %}
