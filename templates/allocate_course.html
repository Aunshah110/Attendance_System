{% extends "base.html" %}
{% block content %}

<style>
  :root{
    --black: #070707;
    --brown-dark: #3e2a1f;
    --brown-mid: #7a5230;
    --brown-light: #d2a679;
    --cream: #f5f5dc;
    --yellow: #FFD24A;
    --glass: rgba(255,255,255,0.06);
    --card-bg: rgba(18,14,12,0.72);
    --accent: linear-gradient(90deg, #b07a49, #8b5a2b);
    --transition: all 0.28s cubic-bezier(.2,.9,.3,1);
  }

  /* Background (STATIC dots) */
  body{
    background: linear-gradient(135deg, var(--brown-light) 0%, var(--cream) 100%);
    min-height:100vh;
    margin:0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: var(--cream);
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background: radial-gradient(circle, rgba(255,255,255,0.08) 10%, transparent 10.5%);
    background-size: 30px 30px;
    z-index:-1;
  }

  .navbar {
    position: fixed !important;
    top: 0; left: 0; right: 0;
    z-index: 9999;
    background: rgba(112, 62, 35, 0.9);
    border-bottom: 2px solid var(--yellow);
  }

  .admin-wrapper {
    padding: calc(130px + 1rem) 1rem 3rem;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  .dashboard-card{
    width: min(900px, 96%);
    background: rgba(112, 62, 35, 0.9);
    border-bottom: 2px solid var(--yellow);
    border-radius: 16px;
    padding: 28px;
    box-shadow: 0 20px 40px rgba(15,10,8,0.35);
    backdrop-filter: blur(8px);
  }

  h1 {
    text-align:center;
    font-size: clamp(1.4rem, 3vw, 1.9rem);
    font-weight: 800;
    color: var(--yellow);
    margin-bottom: 1.2rem;
  }

  /* FORM SIZE OPTIMIZATION */
  form{
    max-width: 760px;
    margin: 0 auto;
    display:flex;
    flex-direction:column;
    gap:1.25rem;
  }

  .form-label {
    font-weight:600;
    font-size: 0.9rem;
  }

  .form-select,
  .form-control {
    border-radius: 8px;
    padding: 8px 12px;
    border: 1.8px solid var(--brown-mid);
    background: var(--cream);
    color: var(--black);
    font-size: 0.9rem;
    max-width: 100%;
  }

  .form-select:focus,
  .form-control:focus {
    outline:none;
    border-color: var(--yellow);
    box-shadow: 0 0 0 3px rgba(255,210,74,0.25);
  }

  /* GRID */
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:1rem;
  }

  .col-md-4,
  .col-md-6{
    flex:1 1 100%;
  }

  @media(min-width:768px){
    .col-md-4{ flex:1 1 30%; }
    .col-md-6{ flex:1 1 48%; }
  }
</style>
<link rel="stylesheet" href="style.css">

<div class="admin-wrapper">
  <div class="dashboard-card">
    <h1>Allocate Course to Teacher</h1>

    <form method="POST">
      <div class="row">
        <div class="col-md-4">
          <label class="form-label">Batch</label>
          <select class="form-select" name="batch_id" id="batch_id" required>
            <option value="">-- Select Batch --</option>
            {% for batch in batches %}
            <option value="{{ batch[0] }}">{{ batch[1] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Department</label>
          <select class="form-select" name="department_id" id="department_id" required>
            <option value="">-- Select Department --</option>
            {% for department in departments %}
            <option value="{{ department[0] }}">{{ department[1] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4 mb-3" id="section-wrapper" style="display:none;">
          <label class="form-label">Section</label>
          <select class="form-select" name="section_id" id="section_id">
            <option value="">-- Select Section --</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <label class="form-label">Semester</label>
          <select class="form-select" name="semester_id" id="semester_id" required>
            <option value="">-- Select Semester --</option>
            {% for semester in semesters %}
            <option value="{{ semester[0] }}">{{ semester[1] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4 mb-3">
          <label for="course_id" class="form-label">Course</label>
          <select class="form-select" id="course_id" name="course_id" required disabled>
              <option value="">-- Select Course --</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-control" name="start_date" id="start_date" required>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <label class="form-label">End Date</label>
          <input type="date" class="form-control" name="end_date" id="end_date" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Teacher</label>
          <select class="form-select" name="teacher_id" required>
            <option value="">-- Select Teacher --</option>
            {% for teacher in teachers %}
            <option value="{{ teacher[0] }}">{{ teacher[1] }} ({{ teacher[0] }})</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="mt-4 d-flex justify-content-center gap-3 flex-wrap">
        <button type="submit" class="btn-dashboard"><span>Allocate Course</span></button>
        <a href="{{ url_for('home') }}" class="btn-dashboard"><span>Back</span></a>
      </div>
    </form>
  </div>
</div>

<!-- Duplicate Allocation Modal -->
<div id="duplicateModal" class="modal-overlay" aria-hidden="true">
  <div class="modal-card">
    <h3>Course Already Allocated</h3>

    <p id="duplicateText">
      This course is already allocated.
    </p>

    <div class="modal-actions">
      <button class="btn-dashboard" id="confirmUpdate">
        <span>Reallocate </span>
      </button>
      <button class="btn-dashboard cancel-btn" id="cancelUpdate">
        <span>Cancel</span>
      </button>
    </div>
  </div>
</div>

{% set duplicate_teacher = none %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, msg in messages %}
    {% if msg.startswith('DUPLICATE::') %}
      {% set duplicate_teacher = msg.replace('DUPLICATE::','') %}
    {% endif %}
  {% endfor %}
{% endwith %}

<div id="flashData" data-duplicate-teacher="{{ duplicate_teacher or '' }}"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {

  const batchSelect = document.getElementById('batch_id');
  const deptSelect = document.getElementById('department_id');
  const sectionWrapper = document.getElementById('section-wrapper');
  const sectionSelect = document.getElementById('section_id');
  const semesterSelect = document.getElementById('semester_id');
  const courseSelect = document.getElementById('course_id');

  const startDate = document.getElementById('start_date');
  const endDate = document.getElementById('end_date');

  const modal = document.getElementById('duplicateModal');
  const dupText = document.getElementById('duplicateText');
  const confirmUpdate = document.getElementById('confirmUpdate');
  const cancelUpdate = document.getElementById('cancelUpdate');

  const form = document.querySelector('form');

  let updateMode = false;   // ðŸ”¥ only valid for current page load

  /* ---------- SECTION ---------- */

  function resetSection(){
    sectionWrapper.style.display = 'none';
    sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';
    sectionSelect.removeAttribute('required');
  }

  async function loadSections(){
    resetSection();

    const batch = batchSelect.value;
    const dept = deptSelect.value;

    if(!batch || !dept) return;

    const res = await fetch(`/admin/check_sections?batch_id=${batch}&department_id=${dept}`);
    const data = await res.json();

    if(data.length){
      sectionWrapper.style.display = 'block';
      sectionSelect.setAttribute('required','required');

      data.forEach(s=>{
        const o = document.createElement('option');
        o.value = s[0];
        o.textContent = s[1];
        sectionSelect.appendChild(o);
      });
    }
  }

  /* ---------- COURSES ---------- */

  function fetchCourses(){
    const batch = batchSelect.value;
    const dept = deptSelect.value;
    const sem = semesterSelect.value;
    const sec = sectionSelect.value || null;

    courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
    courseSelect.disabled = true;

    if(!(batch && dept && sem)) return;

    fetch('/get_courses',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        batch_id:batch,
        department_id:dept,
        semester_id:sem,
        section_id:sec
      })
    })
    .then(r=>r.json())
    .then(data=>{
      if(data.length){
        data.forEach(c=>{
          const o=document.createElement('option');
          o.value=c.id;
          o.textContent=c.name;
          courseSelect.appendChild(o);
        });
        courseSelect.disabled=false;
      }
    });
  }

  /* ---------- DUPLICATE CHECK ---------- */

  async function checkDuplicate(){

    updateMode = false; // reset first

    const course = courseSelect.value;
    if(!course) return;

    const batch = batchSelect.value;
    const dept = deptSelect.value;
    const sem = semesterSelect.value;
    const sec = sectionSelect.value || '';

    const res = await fetch(
      `/admin/check_course_allocation?course_id=${course}&batch_id=${batch}&department_id=${dept}&semester_id=${sem}&section_id=${sec}`
    );

    const data = await res.json();

    if(data.exists){
      dupText.innerHTML =
        `This course is already allocated to <strong>${data.teacher}</strong>.<br>
         Do you want to update the allocation?`;

      modal.classList.add('active');
      modal.setAttribute('aria-hidden','false');
    }
  }

  /* ---------- DATE VALIDATION ---------- */

  function validateDates(){
    if(!startDate.value || !endDate.value) return;

    if(endDate.value <= startDate.value){
      alert("End date must be after start date.");
      endDate.value = '';
    }
  }

  /* ---------- FORM SUBMIT CONTROL ---------- */

  form.addEventListener('submit', (e)=>{

    if(updateMode){
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'force_update';
      hidden.value = '1';
      form.appendChild(hidden);
    }

  });

  /* ---------- MODAL ACTIONS ---------- */

  confirmUpdate.addEventListener('click', ()=>{
    updateMode = true;     // ðŸ”¥ allow update ONCE
    modal.classList.remove('active');
  });

  cancelUpdate.addEventListener('click', ()=>{
    window.location.reload();
  });

  /* ---------- EVENTS ---------- */

  batchSelect.addEventListener('change', ()=>{ loadSections(); fetchCourses(); });
  deptSelect.addEventListener('change', ()=>{ loadSections(); fetchCourses(); });
  sectionSelect.addEventListener('change', fetchCourses);
  semesterSelect.addEventListener('change', fetchCourses);

  courseSelect.addEventListener('change', checkDuplicate);

  startDate.addEventListener('change', validateDates);
  endDate.addEventListener('change', validateDates);

});
</script>


{% endblock %}
